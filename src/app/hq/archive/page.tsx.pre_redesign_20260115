"use client";

import { useState, useRef, useEffect, useCallback } from "react";

const API_BASE = "https://api.guardiacontent.com";

const HQ_CREDENTIALS = {
  username: "jinjurikii",
  pin: "1991"
};

interface Message {
  role: "user" | "assistant" | "system";
  content: string;
  timestamp: Date;
}

interface CortexState {
  awareness: string;
  focus: Array<{ p: number; task: string; owner: string }>;
  pipeline: {
    uploads: Record<string, number>;
    posts: { failed: number; posted: number; scheduled: number };
  };
  services_online: number;
  services_total: number;
}

interface LabFile {
  name: string;
  path: string;
  size: number;
  modified: string;
  type: "image" | "video" | "audio" | "file";
}

interface LabStatus {
  outputs_count: number;
  inbox_count: number;
  current_project: string | null;
  outputs: LabFile[];
  inbox: LabFile[];
}

// Paradise Types
interface CatData {
  name: string;
  id: string;
  market: string;
  style: string;
  timeframe: string;
  status: "online" | "prep" | "offline";
  wins: number;
  losses: number;
  today_pnl: number;
  today_pips: number;
  all_time_pnl: number;
  recent_trades: Array<{
    pair: string;
    result: "win" | "loss";
    pips: number;
    time: string;
  }>;
}

interface ParadiseStatus {
  cats: CatData[];
  fortune: {
    total: number;
    lastUpdated: string;
    dailyHistory: Array<{ date: string; pnl: number }>;
  };
  timestamp: string;
}


// Stock Portfolio Types
interface PortfolioPosition {
  id: number;
  symbol: string;
  cat: string;
  shares: number;
  entry_price: number;
  current_price: number;
  stop_loss: number;
  entry_date: string;
  entry_reason: string;
  pnl: number;
  pnl_pct: number;
}

interface PortfolioData {
  positions: PortfolioPosition[];
  summary: {
    cash: number;
    invested: number;
    current_value: number;
    unrealized_pnl: number;
    unrealized_pct: number;
    realized_pnl: number;
  };
  timestamp: string;
}

// Cat emoji/avatar map
const CAT_AVATARS: Record<string, string> = {
  cheetah: "üêÜ",
  lion: "ü¶Å",
  tiger: "üêÖ",
  jaguar: "üêÜ"
};

// Login Component
function LoginGate({ onSuccess }: { onSuccess: () => void }) {
  const [username, setUsername] = useState("");
  const [pin, setPin] = useState("");
  const [error, setError] = useState("");
  const [loading, setLoading] = useState(false);
  const inputRef = useRef<HTMLInputElement>(null);

  useEffect(() => { inputRef.current?.focus(); }, []);

  const handleSubmit = async () => {
    if (!username.trim() || !pin.trim()) {
      setError("Please enter your credentials.");
      return;
    }
    setLoading(true);
    setError("");
    await new Promise(r => setTimeout(r, 300));
    if (username === HQ_CREDENTIALS.username && pin === HQ_CREDENTIALS.pin) {
      sessionStorage.setItem("hq_auth", "true");
      onSuccess();
    } else {
      setError("Invalid credentials. Access denied.");
      setPin("");
      setLoading(false);
    }
  };

  return (
    <main className="min-h-screen bg-[#0a0a0b] flex items-center justify-center p-4">
      <div className="w-full max-w-md">
        <div className="flex justify-center mb-8">
          <div className="flex items-center gap-3">
            <div className="w-8 h-8 bg-[#a855f7] rounded-lg flex items-center justify-center">
              <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
              </svg>
            </div>
            <span className="text-xl font-semibold text-white">Guardia HQ</span>
          </div>
        </div>
        <div className="bg-[#111113] border border-[#1a1a1f] rounded-2xl p-8">
          <div className="flex items-center gap-3 mb-6">
            <div className="w-12 h-12 bg-gradient-to-br from-[#a855f7] to-[#7c3aed] rounded-xl flex items-center justify-center text-white text-xl font-bold">S</div>
            <div>
              <div className="text-white font-medium">Serberus</div>
              <div className="text-[#555] text-sm">Internal Access</div>
            </div>
          </div>
          <div className="bg-[#0a0a0b] rounded-xl p-4 mb-6">
            <p className="text-[#888] text-sm">This is Guardia&apos;s internal command center. Team members only.</p>
          </div>
          <div className="space-y-4">
            <div>
              <label className="block text-[#555] text-sm mb-2">Username</label>
              <input ref={inputRef} type="text" value={username}
                onChange={(e) => setUsername(e.target.value.toLowerCase().replace(/[^a-z0-9]/g, ""))}
                placeholder="Enter username"
                className="w-full px-4 py-3 bg-[#0a0a0b] border border-[#1a1a1f] rounded-xl text-white placeholder-[#333] focus:outline-none focus:border-[#a855f7]/50 transition-all"
                onKeyDown={(e) => e.key === "Enter" && handleSubmit()}
                disabled={loading}
              />
            </div>
            <div>
              <label className="block text-[#555] text-sm mb-2">PIN</label>
              <input type="password" inputMode="numeric" value={pin}
                onChange={(e) => setPin(e.target.value)}
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                className="w-full px-4 py-3 bg-[#0a0a0b] border border-[#1a1a1f] rounded-xl text-white placeholder-[#333] focus:outline-none focus:border-[#a855f7]/50 transition-all text-center tracking-[0.5em] text-xl"
                onKeyDown={(e) => e.key === "Enter" && handleSubmit()}
                disabled={loading}
              />
            </div>
            {error && <div className="text-red-400 text-sm bg-red-500/10 border border-red-500/20 rounded-lg px-4 py-2">{error}</div>}
            <button onClick={handleSubmit} disabled={loading || !username.trim() || !pin.trim()}
              className="w-full py-3 bg-[#a855f7] text-white font-semibold rounded-xl hover:bg-[#9333ea] disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center justify-center gap-2">
              {loading ? (<><div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin" />Authenticating...</>) : "Sign In"}
            </button>
          </div>
        </div>
      </div>
    </main>
  );
}

// Casino Tab Component - Trade Floor Edition
// Casino Tab Component - Stock Portfolio Edition
function CasinoTab() {
  const [portfolioData, setPortfolioData] = useState<PortfolioData | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const fetchPortfolio = useCallback(async () => {
    try {
      const res = await fetch(`${API_BASE}/hq/paradise/portfolio`);
      if (res.ok) {
        const data = await res.json();
        setPortfolioData(data);
        setError(null);
      } else {
        setError("Failed to fetch portfolio");
      }
    } catch (err) {
      console.error("Portfolio fetch failed:", err);
      setError("Connection error");
    } finally {
      setIsLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchPortfolio();
    const interval = setInterval(fetchPortfolio, 15000);
    return () => clearInterval(interval);
  }, [fetchPortfolio]);

  const formatMoney = (value: number) => {
    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
  };

  const formatPct = (value: number) => {
    const prefix = value >= 0 ? "+" : "";
    return `${prefix}${value.toFixed(2)}%`;
  };

  // Group positions by cat
  const positionsByCat = portfolioData?.positions.reduce((acc, pos) => {
    if (!acc[pos.cat]) acc[pos.cat] = [];
    acc[pos.cat].push(pos);
    return acc;
  }, {} as Record<string, PortfolioPosition[]>) || {};

  const catInfo: Record<string, { name: string; emoji: string; strategy: string }> = {
    lion: { name: "Lion", emoji: "ü¶Å", strategy: "Value + Dividends" },
    cheetah: { name: "Cheetah", emoji: "üêÜ", strategy: "Momentum" },
    jaguar: { name: "Jaguar", emoji: "üêÜ", strategy: "Quality/GARP" },
    tiger: { name: "Tiger", emoji: "üêÖ", strategy: "Special Situations" }
  };

  if (isLoading) {
    return (
      <div className="h-full flex items-center justify-center bg-[#050506]">
        <div className="text-center">
          <div className="w-10 h-10 border-2 border-[#222] border-t-[#00ff88] rounded-full animate-spin mx-auto mb-4" />
          <div className="text-[#444] text-sm font-medium tracking-wider">LOADING PORTFOLIO...</div>
        </div>
      </div>
    );
  }

  const summary = portfolioData?.summary;

  return (
    <div className="h-full flex flex-col bg-[#050506]">
      {/* Portfolio Header */}
      <div className="px-6 py-4 border-b border-[#1a1a1f] bg-gradient-to-r from-[#0a0a0b] to-[#111113]">
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-3">
            <div className="w-3 h-3 rounded-full bg-[#00ff88] animate-pulse" />
            <h1 className="text-lg font-semibold text-white tracking-wide">PARADISE PORTFOLIO</h1>
          </div>
          <button onClick={fetchPortfolio}
            className="px-3 py-1.5 bg-[#111] border border-[#222] text-[#666] text-[10px] uppercase tracking-widest hover:border-[#00ff88] hover:text-[#00ff88] transition-all rounded">
            ‚Üª Refresh
          </button>
        </div>
        
        {/* Portfolio Summary */}
        <div className="grid grid-cols-5 gap-4">
          <div className="bg-[#080808] border border-[#151515] rounded-xl p-3 text-center">
            <div className="text-[9px] text-[#444] uppercase tracking-wider mb-1">Cash</div>
            <div className="text-lg font-bold text-white">{formatMoney(summary?.cash || 0)}</div>
          </div>
          <div className="bg-[#080808] border border-[#151515] rounded-xl p-3 text-center">
            <div className="text-[9px] text-[#444] uppercase tracking-wider mb-1">Invested</div>
            <div className="text-lg font-bold text-[#888]">{formatMoney(summary?.invested || 0)}</div>
          </div>
          <div className="bg-[#080808] border border-[#151515] rounded-xl p-3 text-center">
            <div className="text-[9px] text-[#444] uppercase tracking-wider mb-1">Current Value</div>
            <div className="text-lg font-bold text-white">{formatMoney(summary?.current_value || 0)}</div>
          </div>
          <div className="bg-[#080808] border border-[#151515] rounded-xl p-3 text-center">
            <div className="text-[9px] text-[#444] uppercase tracking-wider mb-1">Unrealized P/L</div>
            <div className={`text-lg font-bold ${(summary?.unrealized_pnl || 0) >= 0 ? "text-[#00ff88]" : "text-[#ff4444]"}`}>
              {formatMoney(summary?.unrealized_pnl || 0)}
              <span className="text-xs ml-1">({formatPct(summary?.unrealized_pct || 0)})</span>
            </div>
          </div>
          <div className="bg-[#080808] border border-[#151515] rounded-xl p-3 text-center">
            <div className="text-[9px] text-[#444] uppercase tracking-wider mb-1">Realized P/L</div>
            <div className={`text-lg font-bold ${(summary?.realized_pnl || 0) >= 0 ? "text-[#00ff88]" : "text-[#ff4444]"}`}>
              {formatMoney(summary?.realized_pnl || 0)}
            </div>
          </div>
        </div>
      </div>

      {/* Positions by Cat */}
      <div className="flex-1 p-6 overflow-auto">
        {Object.keys(positionsByCat).length === 0 ? (
          <div className="text-center py-16 text-[#444]">
            <div className="text-4xl mb-4">üìä</div>
            <div className="text-sm">No open positions</div>
          </div>
        ) : (
          <div className="space-y-6">
            {["cheetah", "lion", "jaguar", "tiger"].map((cat) => {
              const positions = positionsByCat[cat];
              if (!positions || positions.length === 0) return null;
              
              const info = catInfo[cat];
              const catPnl = positions.reduce((sum, p) => sum + p.pnl, 0);
              
              return (
                <div key={cat} className="bg-[#0a0a0b] border border-[#1a1a1f] rounded-2xl overflow-hidden">
                  {/* Cat Header */}
                  <div className="px-5 py-4 border-b border-[#1a1a1f] flex items-center justify-between bg-gradient-to-r from-[#111113] to-[#0d0d0f]">
                    <div className="flex items-center gap-4">
                      <span className="text-3xl">{info.emoji}</span>
                      <div>
                        <div className="text-lg font-bold text-white">{info.name}</div>
                        <div className="text-[11px] text-[#555]">{info.strategy} ‚Ä¢ {positions.length} positions</div>
                      </div>
                    </div>
                    <div className={`text-xl font-bold ${catPnl >= 0 ? "text-[#00ff88]" : "text-[#ff4444]"}`}>
                      {formatMoney(catPnl)}
                    </div>
                  </div>
                  
                  {/* Positions Table */}
                  <div className="p-4">
                    <table className="w-full">
                      <thead>
                        <tr className="text-[10px] text-[#444] uppercase tracking-wider">
                          <th className="text-left pb-3">Symbol</th>
                          <th className="text-right pb-3">Shares</th>
                          <th className="text-right pb-3">Entry</th>
                          <th className="text-right pb-3">Current</th>
                          <th className="text-right pb-3">Stop</th>
                          <th className="text-right pb-3">P/L</th>
                          <th className="text-right pb-3">%</th>
                        </tr>
                      </thead>
                      <tbody>
                        {positions.map((pos) => (
                          <tr key={pos.id} className="border-t border-[#111] text-sm">
                            <td className="py-3">
                              <div className="font-semibold text-white">{pos.symbol}</div>
                              <div className="text-[10px] text-[#444] truncate max-w-[200px]">{pos.entry_reason}</div>
                            </td>
                            <td className="text-right text-[#888]">{pos.shares}</td>
                            <td className="text-right text-[#888]">${pos.entry_price.toFixed(2)}</td>
                            <td className="text-right text-white">${pos.current_price.toFixed(2)}</td>
                            <td className="text-right text-[#555]">${pos.stop_loss.toFixed(2)}</td>
                            <td className={`text-right font-semibold ${pos.pnl >= 0 ? "text-[#00ff88]" : "text-[#ff4444]"}`}>
                              {formatMoney(pos.pnl)}
                            </td>
                            <td className={`text-right font-semibold ${pos.pnl_pct >= 0 ? "text-[#00ff88]" : "text-[#ff4444]"}`}>
                              {formatPct(pos.pnl_pct)}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>

      {/* Footer */}
      {error && (
        <div className="border-t border-[#1a1a1f] bg-[#0a0a0b] px-6 py-3">
          <div className="text-[11px] text-red-400 bg-red-500/10 px-3 py-1.5 rounded">{error}</div>
        </div>
      )}
    </div>
  );
}



function LabTab() {
  const [labStatus, setLabStatus] = useState<LabStatus | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [isDragging, setIsDragging] = useState(false);
  const [uploadProgress, setUploadProgress] = useState<string | null>(null);
  const [selectedFile, setSelectedFile] = useState<LabFile | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);

  const fetchLabStatus = useCallback(async () => {
    try {
      const res = await fetch(`${API_BASE}/hq/lab/status`);
      if (res.ok) {
        const data = await res.json();
        setLabStatus(data);
      }
    } catch (err) {
      console.error("Lab status fetch failed:", err);
    } finally {
      setIsLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchLabStatus();
    const interval = setInterval(fetchLabStatus, 10000);
    return () => clearInterval(interval);
  }, [fetchLabStatus]);

  const handleDrop = async (e: React.DragEvent) => {
    e.preventDefault();
    setIsDragging(false);
    const files = Array.from(e.dataTransfer.files);
    if (files.length > 0) await uploadFiles(files);
  };

  const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(e.target.files || []);
    if (files.length > 0) await uploadFiles(files);
  };

  const uploadFiles = async (files: File[]) => {
    for (const file of files) {
      setUploadProgress(`Uploading ${file.name}...`);
      try {
        const formData = new FormData();
        formData.append("file", file);
        const res = await fetch(`${API_BASE}/hq/lab/upload`, { method: "POST", body: formData });
        if (!res.ok) throw new Error("Upload failed");
        await fetchLabStatus();
      } catch (err) {
        console.error("Upload error:", err);
      }
    }
    setUploadProgress(null);
  };

  const deleteFile = async (folder: string, filename: string) => {
    try {
      await fetch(`${API_BASE}/hq/lab/file/${folder}/${filename}`, { method: "DELETE" });
      await fetchLabStatus();
      if (selectedFile?.name === filename) setSelectedFile(null);
    } catch (err) {
      console.error("Delete error:", err);
    }
  };

  const formatSize = (bytes: number) => {
    if (bytes < 1024) return `${bytes} B`;
    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
  };

  const FileCard = ({ file, folder }: { file: LabFile; folder: "outputs" | "inbox" }) => {
    const isSelected = selectedFile?.name === file.name;
    const fileUrl = `${API_BASE}/hq/lab/file/${folder}/${file.name}`;
    
    return (
      <div onClick={() => setSelectedFile(isSelected ? null : file)}
        className={`group relative bg-[#111113] border rounded-xl p-3 cursor-pointer transition-all hover:border-[#333] ${
          isSelected ? "border-[#a855f7] ring-1 ring-[#a855f7]/30" : "border-[#1a1a1f]"
        }`}>
        <div className="aspect-video bg-[#0a0a0b] rounded-lg mb-2 flex items-center justify-center overflow-hidden">
          {file.type === "image" ? (
            <img src={fileUrl} alt={file.name} className="w-full h-full object-cover" />
          ) : file.type === "video" ? (
            <video src={fileUrl} className="w-full h-full object-cover" muted />
          ) : (
            <div className="text-3xl opacity-30">üìÑ</div>
          )}
        </div>
        <div className="text-[12px] text-[#e8e8e8] truncate mb-1">{file.name}</div>
        <div className="flex justify-between text-[11px] text-[#555]">
          <span>{formatSize(file.size)}</span>
        </div>
        <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
          <a href={fileUrl} download={file.name} onClick={(e) => e.stopPropagation()}
            className="w-7 h-7 bg-[#1a1a1f] border border-[#333] rounded-lg flex items-center justify-center text-[11px] text-white hover:bg-[#333]">‚Üì</a>
          <button onClick={(e) => { e.stopPropagation(); deleteFile(folder, file.name); }}
            className="w-7 h-7 bg-[#1a1a1f] border border-[#333] rounded-lg flex items-center justify-center text-[11px] text-white hover:bg-red-500/20 hover:border-red-500/50 hover:text-red-400">√ó</button>
        </div>
      </div>
    );
  };

  return (
    <div className="h-full flex bg-[#0a0a0b]">
      <div className="flex-1 p-6 overflow-auto">
        <div className="flex items-center justify-between mb-6">
          <div>
            <h1 className="text-xl font-semibold text-white">Serberus Lab</h1>
            <div className="text-sm text-[#555] mt-1">
              Project: <span className="text-[#a855f7]">{labStatus?.current_project || "pyramid-zero"}</span>
            </div>
          </div>
          <button onClick={fetchLabStatus}
            className="px-4 py-2 bg-[#1a1a1f] border border-[#333] text-[#555] text-sm hover:border-[#a855f7]/50 hover:text-white transition-all rounded-xl">
            ‚Üª Refresh
          </button>
        </div>

        <div className="grid grid-cols-2 gap-6">
          <div className="bg-[#111113] border border-[#1a1a1f] rounded-2xl overflow-hidden">
            <div className="px-5 py-4 border-b border-[#1a1a1f] flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2.5 h-2.5 rounded-full bg-[#a855f7] animate-pulse" />
                <span className="text-sm font-medium text-white">Serberus Outputs</span>
              </div>
              <span className="text-xs text-[#555] bg-[#1a1a1f] px-2 py-1 rounded-md">{labStatus?.outputs_count || 0} files</span>
            </div>
            <div className="p-4 max-h-[500px] overflow-auto">
              {isLoading ? (
                <div className="text-center py-8 text-[#555] text-sm">
                  <div className="w-5 h-5 border-2 border-[#333] border-t-[#a855f7] rounded-full animate-spin mx-auto mb-2" />
                  Loading...
                </div>
              ) : !labStatus?.outputs?.length ? (
                <div className="text-center py-8 text-[#555] text-sm">
                  <div className="text-3xl mb-2 opacity-30">üî¨</div>
                  No outputs yet
                </div>
              ) : (
                <div className="grid grid-cols-2 gap-3">
                  {labStatus.outputs.map((file) => <FileCard key={file.name} file={file} folder="outputs" />)}
                </div>
              )}
            </div>
          </div>

          <div className="bg-[#111113] border border-[#1a1a1f] rounded-2xl overflow-hidden">
            <div className="px-5 py-4 border-b border-[#1a1a1f] flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2.5 h-2.5 rounded-full bg-[#22c55e]" />
                <span className="text-sm font-medium text-white">Your Dropbox</span>
              </div>
              <span className="text-xs text-[#555] bg-[#1a1a1f] px-2 py-1 rounded-md">{labStatus?.inbox_count || 0} files</span>
            </div>
            <div className="p-4">
              <div onDragOver={(e) => { e.preventDefault(); setIsDragging(true); }}
                onDragLeave={() => setIsDragging(false)} onDrop={handleDrop}
                onClick={() => fileInputRef.current?.click()}
                className={`border-2 border-dashed rounded-xl p-8 text-center cursor-pointer transition-all mb-4 ${
                  isDragging ? "border-[#22c55e] bg-[#22c55e]/10" : "border-[#333] hover:border-[#555] hover:bg-[#111113]"
                }`}>
                <input ref={fileInputRef} type="file" multiple onChange={handleFileSelect} className="hidden" />
                {uploadProgress ? (
                  <div className="text-[#22c55e] text-sm flex items-center justify-center gap-2">
                    <div className="w-4 h-4 border-2 border-[#22c55e]/30 border-t-[#22c55e] rounded-full animate-spin" />
                    {uploadProgress}
                  </div>
                ) : (
                  <>
                    <div className="text-3xl mb-2">üì•</div>
                    <div className="text-[#555] text-sm">Drop files or click to upload</div>
                  </>
                )}
              </div>
              <div className="max-h-[350px] overflow-auto">
                {!labStatus?.inbox?.length ? (
                  <div className="text-center py-4 text-[#555] text-sm">No files in inbox</div>
                ) : (
                  <div className="grid grid-cols-2 gap-3">
                    {labStatus.inbox.map((file) => <FileCard key={file.name} file={file} folder="inbox" />)}
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>

      {selectedFile && (
        <div className="w-80 border-l border-[#1a1a1f] bg-[#111113] p-4">
          <div className="flex items-center justify-between mb-4">
            <span className="text-sm font-medium text-white">Preview</span>
            <button onClick={() => setSelectedFile(null)} className="text-[#555] hover:text-white text-lg">√ó</button>
          </div>
          <div className="aspect-video bg-[#0a0a0b] rounded-xl overflow-hidden mb-4">
            {selectedFile.type === "image" ? (
              <img src={`${API_BASE}/hq/lab/file/${labStatus?.outputs?.find(f => f.name === selectedFile.name) ? "outputs" : "inbox"}/${selectedFile.name}`}
                alt={selectedFile.name} className="w-full h-full object-contain" />
            ) : selectedFile.type === "video" ? (
              <video src={`${API_BASE}/hq/lab/file/${labStatus?.outputs?.find(f => f.name === selectedFile.name) ? "outputs" : "inbox"}/${selectedFile.name}`}
                controls className="w-full h-full" />
            ) : (
              <div className="flex items-center justify-center h-full text-4xl opacity-30">üìÑ</div>
            )}
          </div>
          <div className="space-y-3 text-sm">
            <div className="flex justify-between"><span className="text-[#555]">Name</span><span className="text-[#e8e8e8] truncate max-w-[180px]">{selectedFile.name}</span></div>
            <div className="flex justify-between"><span className="text-[#555]">Size</span><span className="text-[#e8e8e8]">{formatSize(selectedFile.size)}</span></div>
            <div className="flex justify-between"><span className="text-[#555]">Type</span><span className="text-[#e8e8e8]">{selectedFile.type}</span></div>
          </div>
        </div>
      )}
    </div>
  );
}

// Chat Tab
function ChatTab() {
  const [messages, setMessages] = useState<Message[]>([]);
  const [input, setInput] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const [cortexState, setCortexState] = useState<CortexState | null>(null);
  const messagesEndRef = useRef<HTMLDivElement>(null);

  useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);

  const fetchCortexState = useCallback(async () => {
    try {
      const res = await fetch(`${API_BASE}/hq/cortex-state`);
      if (res.ok) setCortexState(await res.json());
    } catch (err) { console.error("Cortex fetch failed:", err); }
  }, []);

  useEffect(() => {
    fetchCortexState();
    const interval = setInterval(fetchCortexState, 30000);
    return () => clearInterval(interval);
  }, [fetchCortexState]);

  const sendMessage = async () => {
    if (!input.trim() || isLoading) return;
    setMessages((prev) => [...prev, { role: "user", content: input, timestamp: new Date() }]);
    setInput("");
    setIsLoading(true);

    try {
      const res = await fetch(`${API_BASE}/hq/chat`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: input, history: messages.slice(-10) })
      });
      const data = await res.json();
      setMessages((prev) => [...prev, { role: "assistant", content: data.response || "No response", timestamp: new Date() }]);
    } catch {
      setMessages((prev) => [...prev, { role: "assistant", content: "Connection error", timestamp: new Date() }]);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="h-full flex flex-col bg-[#0a0a0b]">
      {cortexState && (
        <div className="p-4 border-b border-[#1a1a1f] bg-[#111113]">
          <div className="text-xs text-[#555] mb-2">CORTEX AWARENESS</div>
          <div className="text-sm text-[#888] line-clamp-2">{cortexState.awareness}</div>
          <div className="flex gap-4 mt-2 text-xs">
            <span className="text-[#22c55e]">{cortexState.services_online}/{cortexState.services_total} services</span>
            <span className="text-[#a855f7]">{cortexState.pipeline?.posts?.scheduled || 0} scheduled</span>
          </div>
        </div>
      )}
      <div className="flex-1 overflow-auto p-4 space-y-4">
        {messages.map((msg, i) => (
          <div key={i} className={`flex ${msg.role === "user" ? "justify-end" : "justify-start"}`}>
            <div className={`max-w-[80%] px-4 py-3 rounded-2xl text-sm ${
              msg.role === "user" ? "bg-[#a855f7] text-white" : "bg-[#111113] border border-[#1a1a1f] text-[#e8e8e8]"
            }`}>
              <pre className="whitespace-pre-wrap font-sans text-sm">{msg.content}</pre>
            </div>
          </div>
        ))}
        {isLoading && (
          <div className="flex justify-start">
            <div className="bg-[#111113] border border-[#1a1a1f] px-4 py-3 rounded-2xl text-[#555] text-sm flex items-center gap-2">
              <div className="w-4 h-4 border-2 border-[#333] border-t-[#a855f7] rounded-full animate-spin" />
              Thinking...
            </div>
          </div>
        )}
        <div ref={messagesEndRef} />
      </div>
      <div className="p-4 border-t border-[#1a1a1f] bg-[#111113]">
        <div className="flex gap-3">
          <input type="text" value={input} onChange={(e) => setInput(e.target.value)}
            onKeyDown={(e) => e.key === "Enter" && sendMessage()}
            placeholder="Message Serberus..."
            className="flex-1 bg-[#0a0a0b] border border-[#1a1a1f] text-white px-4 py-3 text-sm outline-none focus:border-[#a855f7]/50 rounded-xl placeholder-[#333]" />
          <button onClick={sendMessage} disabled={isLoading}
            className="px-6 py-3 bg-[#a855f7] text-white text-sm font-medium hover:bg-[#9333ea] disabled:opacity-50 rounded-xl transition-all">
            Send
          </button>
        </div>
      </div>
    </div>
  );
}

// Main HQ Page
export default function HQPage() {
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [activeTab, setActiveTab] = useState<"lab" | "chat" | "casino">("lab");

  useEffect(() => {
    if (sessionStorage.getItem("hq_auth") === "true") setIsAuthenticated(true);
  }, []);

  if (!isAuthenticated) {
    return <LoginGate onSuccess={() => setIsAuthenticated(true)} />;
  }

  return (
    <div className="min-h-screen bg-[#0a0a0b] flex flex-col">
      {/* Header */}
      <div className="border-b border-[#1a1a1f] px-6 py-4 flex items-center justify-between bg-[#111113]">
        <div className="flex items-center gap-6">
          <div className="flex items-center gap-2">
            <div className="w-6 h-6 bg-[#a855f7] rounded-md flex items-center justify-center">
              <svg className="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
              </svg>
            </div>
            <span className="text-white font-medium">Guardia HQ</span>
          </div>
          <div className="flex gap-1 bg-[#0a0a0b] p-1 rounded-xl">
            <button onClick={() => setActiveTab("lab")}
              className={`px-4 py-2 text-sm transition-all rounded-lg ${
                activeTab === "lab" ? "bg-[#a855f7] text-white" : "text-[#555] hover:text-white"
              }`}>Lab</button>
            <button onClick={() => setActiveTab("chat")}
              className={`px-4 py-2 text-sm transition-all rounded-lg ${
                activeTab === "chat" ? "bg-[#a855f7] text-white" : "text-[#555] hover:text-white"
              }`}>Chat</button>
            <button onClick={() => setActiveTab("casino")}
              className={`px-4 py-2 text-sm transition-all rounded-lg ${
                activeTab === "casino" ? "bg-[#ffaa00] text-black font-medium" : "text-[#555] hover:text-white"
              }`}>Casino</button>
          </div>
        </div>
        <button onClick={() => { sessionStorage.removeItem("hq_auth"); setIsAuthenticated(false); }}
          className="text-sm text-[#555] hover:text-white transition-colors">Logout</button>
      </div>

      {/* Content */}
      <div className="flex-1 overflow-hidden">
        {activeTab === "lab" ? <LabTab /> : activeTab === "chat" ? <ChatTab /> : <CasinoTab />}
      </div>
    </div>
  );
}
